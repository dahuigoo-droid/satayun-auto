# ì‚¬ì£¼ í†µí•© ìë™í™” ì‹œìŠ¤í…œ v2
# - ì´ë¯¸ì§€ ìƒì„± + Claude API í•´ì„ + PDF ìƒì„± + ë°œì†¡
import streamlit as st
import pandas as pd
from datetime import datetime
import zipfile
import io
import os
from korean_lunar_calendar import KoreanLunarCalendar

# ì¶”ê°€ ëª¨ë“ˆ (ì„ íƒì  ë¡œë“œ)
try:
    from claude_api import SajuInterpreter, load_prompts_from_dir, estimate_cost, create_all_chapter_docx
    from pdf_generator import create_pdf, read_docx, setup_fonts as setup_pdf_fonts
    from delivery import send_email, send_bulk_emails, get_default_email_template
    from google_drive import upload_to_drive
    MODULES_AVAILABLE = True
except ImportError as e:
    MODULES_AVAILABLE = False
    IMPORT_ERROR = str(e)

from saju_calculator import (
    calc_ì‚¬ì£¼, calc_ëŒ€ìš´, calc_ì„¸ìš´, calc_ì›”ìš´, calc_ì‹ ì‚´,
    calc_í•©ì¶©í˜•íŒŒí•´, calc_ì²œê°„í•©, calc_ê¶ì„±, calc_ìœ¡ì¹œ, 
    calc_ë‚©ìŒì˜¤í–‰, calc_ê²©êµ­, calc_ê³µë§_ì „ì²´, calc_ìš©ì‹ 
)
from image_generator import (
    create_ì›êµ­í‘œ, create_ëŒ€ìš´í‘œ, create_ì„¸ìš´í‘œ, create_ì›”ìš´í‘œ, 
    create_ì˜¤í–‰ì°¨íŠ¸, create_ì‹­ì„±í‘œ, create_ì‹ ì‚´í‘œ,
    create_12ìš´ì„±í‘œ, create_ì§€ì¥ê°„í‘œ, create_í•©ì¶©í˜•íŒŒí•´í‘œ,
    create_ê¶ì„±í‘œ, create_ìœ¡ì¹œí‘œ, create_ë‚©ìŒì˜¤í–‰í‘œ,
    create_ê²©êµ­í‘œ, create_ê³µë§í‘œ, create_ìš©ì‹ í‘œ, create_ì¼ì§„í‘œ
)

# 12ì§€ ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •
ZODIAC_PATH = os.path.join(os.path.dirname(__file__), 'images', 'zodiac')

# ============================================
# GPTìš© í…ìŠ¤íŠ¸ í¬ë§· ìƒì„± í•¨ìˆ˜
# ============================================
def generate_gpt_text(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, gender, ëŒ€ìš´_data, ì„¸ìš´_data, ì›”ìš´_data, ì‹ ì‚´_data):
    """GPT í•´ì„ìš© í‘œì¤€ í…ìŠ¤íŠ¸ í¬ë§· ìƒì„±"""
    
    # ì¶”ê°€ ê³„ì‚°
    ìš©ì‹ _data = calc_ìš©ì‹ (ì‚¬ì£¼)
    í•©ì¶©í˜•íŒŒí•´ = calc_í•©ì¶©í˜•íŒŒí•´(ì‚¬ì£¼)
    ì²œê°„í•© = calc_ì²œê°„í•©(ì‚¬ì£¼)
    ê¶ì„± = calc_ê¶ì„±(ì‚¬ì£¼)
    ìœ¡ì¹œ = calc_ìœ¡ì¹œ(ì‚¬ì£¼, gender)
    ë‚©ìŒ = calc_ë‚©ìŒì˜¤í–‰(ì‚¬ì£¼)
    ê²©êµ­ = calc_ê²©êµ­(ì‚¬ì£¼)
    ê³µë§ = calc_ê³µë§_ì „ì²´(ì‚¬ì£¼)
    
    # ì›êµ­ ë°ì´í„°
    ë…„ì£¼ = ì‚¬ì£¼['ë…„ì£¼']
    ì›”ì£¼ = ì‚¬ì£¼['ì›”ì£¼']
    ì¼ì£¼ = ì‚¬ì£¼['ì¼ì£¼']
    ì‹œì£¼ = ì‚¬ì£¼['ì‹œì£¼']
    ì²œê°„ì‹­ì„± = ì‚¬ì£¼['ì²œê°„ì‹­ì„±']
    ì§€ì§€ì‹­ì„± = ì‚¬ì£¼['ì§€ì§€ì‹­ì„±']
    ìš´ì„± = ì‚¬ì£¼['12ìš´ì„±']
    ì§€ì¥ê°„ = ì‚¬ì£¼['ì§€ì¥ê°„']
    ì˜¤í–‰ = ì‚¬ì£¼['ì˜¤í–‰']
    
    text = f"""â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ì‚¬ì£¼ ë¶„ì„ ê¸°ì¤€ ë°ì´í„° (GPT í•´ì„ìš©)
â€» ë³¸ ë°ì´í„°ëŠ” ê³„ì‚° ê²°ê³¼ì´ë©°, í•´ì„Â·í‰ê°€Â·ì˜ë¯¸ ë¶€ì—¬ëŠ”
   ì¥ë³„ ë¶„ì„ í”„ë¡¬í”„íŠ¸ì—ì„œë§Œ ìˆ˜í–‰í•  ê²ƒ.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â–  ê¸°ë³¸ì •ë³´
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì´ë¦„: {ê¸°ë³¸ì •ë³´['ì´ë¦„']}
ì„±ë³„: {ê¸°ë³¸ì •ë³´['ì„±ë³„']}
ë‚˜ì´: {ê¸°ë³¸ì •ë³´['ë‚˜ì´']}ì„¸
ì–‘ë ¥: {ê¸°ë³¸ì •ë³´['ì–‘ë ¥']}
ìŒë ¥: {ê¸°ë³¸ì •ë³´['ìŒë ¥']}

â–  1. ì›êµ­í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ì‹œì£¼        ì¼ì£¼        ì›”ì£¼        ë…„ì£¼
ì²œê°„    {ì‹œì£¼[0]}          {ì¼ì£¼[0]}          {ì›”ì£¼[0]}          {ë…„ì£¼[0]}
ì§€ì§€    {ì‹œì£¼[1]}          {ì¼ì£¼[1]}          {ì›”ì£¼[1]}          {ë…„ì£¼[1]}
ì²œê°„ì‹­ì„± {ì²œê°„ì‹­ì„±['ì‹œ']}     (ì¼ê°„)      {ì²œê°„ì‹­ì„±['ì›”']}     {ì²œê°„ì‹­ì„±['ë…„']}
ì§€ì§€ì‹­ì„± {ì§€ì§€ì‹­ì„±['ì‹œ']}     {ì§€ì§€ì‹­ì„±['ì¼']}     {ì§€ì§€ì‹­ì„±['ì›”']}     {ì§€ì§€ì‹­ì„±['ë…„']}
12ìš´ì„±  {ìš´ì„±['ì‹œ']}        {ìš´ì„±['ì¼']}        {ìš´ì„±['ì›”']}        {ìš´ì„±['ë…„']}

ì¼ê°„: {ì¼ì£¼[0]} (ì˜¤í–‰: {ìš©ì‹ _data['ì¼ê°„_ì˜¤í–‰']})

â–  2. ëŒ€ìš´í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ëŒ€ìš´ìˆ˜: {ëŒ€ìš´_data['ëŒ€ìš´ìˆ˜']}ì„¸ ì‹œì‘ | ë°©í–¥: {'ìˆœí–‰' if ëŒ€ìš´_data['ìˆœí–‰'] else 'ì—­í–‰'}
"""
    
    # ëŒ€ìš´ ëª©ë¡
    for i, ëŒ€ìš´ in enumerate(ëŒ€ìš´_data['ëŒ€ìš´'][:12]):
        text += f"{ëŒ€ìš´['ë‚˜ì´']}ì„¸: {ëŒ€ìš´['ì²œê°„']}{ëŒ€ìš´['ì§€ì§€']} | "
        if (i + 1) % 4 == 0:
            text += "\n"
    
    text += f"""
â–  3. ì„¸ìš´í‘œ (10ë…„)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    for ì„¸ìš´ in ì„¸ìš´_data['ì„¸ìš´']:
        text += f"{ì„¸ìš´['ë…„ë„']}ë…„: {ì„¸ìš´['ì²œê°„']}{ì„¸ìš´['ì§€ì§€']} (ì²œê°„ì‹­ì„±:{ì„¸ìš´['ì²œê°„_ì‹­ì„±']}, ì§€ì§€ì‹­ì„±:{ì„¸ìš´['ì§€ì§€_ì‹­ì„±']})\n"
    
    text += f"""
â–  4. ì›”ìš´í‘œ (12ê°œì›”)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    for ì›”ìš´ in ì›”ìš´_data['ì›”ìš´']:
        text += f"{ì›”ìš´['ë…„ë„']}ë…„ {ì›”ìš´['ì›”']}ì›”: {ì›”ìš´['ì²œê°„']}{ì›”ìš´['ì§€ì§€']} (ì²œê°„ì‹­ì„±:{ì›”ìš´['ì²œê°„_ì‹­ì„±']}, ì§€ì§€ì‹­ì„±:{ì›”ìš´['ì§€ì§€_ì‹­ì„±']})\n"
    
    text += f"""
â–  5. ì˜¤í–‰ë¶„ì„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ëª©:{ì˜¤í–‰['ëª©']} í™”:{ì˜¤í–‰['í™”']} í† :{ì˜¤í–‰['í† ']} ê¸ˆ:{ì˜¤í–‰['ê¸ˆ']} ìˆ˜:{ì˜¤í–‰['ìˆ˜']}
ì´í•©: {sum(ì˜¤í–‰.values())}ê°œ
"""
    
    # ê°•/ì•½/ë¬´ ê³„ì‚°
    sorted_ì˜¤í–‰ = sorted(ì˜¤í–‰.items(), key=lambda x: x[1], reverse=True)
    ê°•í•œ = sorted_ì˜¤í–‰[0][0] if sorted_ì˜¤í–‰[0][1] > 0 else "-"
    ì¡´ì¬í•˜ëŠ” = [(k, v) for k, v in sorted_ì˜¤í–‰ if v > 0]
    ì•½í•œ = ì¡´ì¬í•˜ëŠ”[-1][0] if ì¡´ì¬í•˜ëŠ” else "-"
    ì—†ëŠ” = [k for k, v in ì˜¤í–‰.items() if v == 0]
    
    text += f"ê°•: {ê°•í•œ} | ì•½: {ì•½í•œ}"
    if ì—†ëŠ”:
        text += f" | ë¬´: {','.join(ì—†ëŠ”)}"
    
    text += f"""

â–  6. ì‹­ì„±í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì²œê°„ì‹­ì„±: ë…„({ì²œê°„ì‹­ì„±['ë…„']}) ì›”({ì²œê°„ì‹­ì„±['ì›”']}) ì¼(ì¼ê°„) ì‹œ({ì²œê°„ì‹­ì„±['ì‹œ']})
ì§€ì§€ì‹­ì„±: ë…„({ì§€ì§€ì‹­ì„±['ë…„']}) ì›”({ì§€ì§€ì‹­ì„±['ì›”']}) ì¼({ì§€ì§€ì‹­ì„±['ì¼']}) ì‹œ({ì§€ì§€ì‹­ì„±['ì‹œ']})

â–  7. ì‹ ì‚´í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ê¸¸ì‹ ]
"""
    if ì‹ ì‚´_data.get('ê¸¸ì‹ '):
        for ì‹ ì‚´ëª…, ìœ„ì¹˜ in ì‹ ì‚´_data['ê¸¸ì‹ ']:
            text += f"- {ì‹ ì‚´ëª…} ({ìœ„ì¹˜})\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[í‰ì‹ ]\n"
    if ì‹ ì‚´_data.get('í‰ì‹ '):
        for ì‹ ì‚´ëª…, ìœ„ì¹˜ in ì‹ ì‚´_data['í‰ì‹ ']:
            text += f"- {ì‹ ì‚´ëª…} ({ìœ„ì¹˜})\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[íŠ¹ìˆ˜ì‹ ì‚´]\n"
    if ì‹ ì‚´_data.get('íŠ¹ìˆ˜ì‹ ì‚´'):
        for ì‹ ì‚´ëª…, ìœ„ì¹˜ in ì‹ ì‚´_data['íŠ¹ìˆ˜ì‹ ì‚´']:
            text += f"- {ì‹ ì‚´ëª…} ({ìœ„ì¹˜})\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += f"""
â–  8. 12ìš´ì„±í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì¼ê°„({ì¼ì£¼[0]}) ê¸°ì¤€ ê° ì§€ì§€ë³„ 12ìš´ì„±:
ë…„ì§€({ë…„ì£¼[1]}): {ìš´ì„±['ë…„']} | ì›”ì§€({ì›”ì£¼[1]}): {ìš´ì„±['ì›”']} | ì¼ì§€({ì¼ì£¼[1]}): {ìš´ì„±['ì¼']} | ì‹œì§€({ì‹œì£¼[1]}): {ìš´ì„±['ì‹œ']}

â–  9. ì§€ì¥ê°„í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ë…„ì§€({ë…„ì£¼[1]}): {ì§€ì¥ê°„['ë…„']}
ì›”ì§€({ì›”ì£¼[1]}): {ì§€ì¥ê°„['ì›”']}
ì¼ì§€({ì¼ì£¼[1]}): {ì§€ì¥ê°„['ì¼']}
ì‹œì§€({ì‹œì£¼[1]}): {ì§€ì¥ê°„['ì‹œ']}

â–  10. í•©ì¶©í˜•íŒŒí•´í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ì²œê°„í•©]
"""
    if ì²œê°„í•©:
        for í•© in ì²œê°„í•©:
            text += f"- {í•©['ì²œê°„']} â†’ {í•©['í•©í™”']} ({í•©['ìœ„ì¹˜']})\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[ì§€ì§€ ìœ¡í•©]\n"
    if í•©ì¶©í˜•íŒŒí•´['ìœ¡í•©']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['ìœ¡í•©']:
            if isinstance(í•­ëª©, dict):
                text += f"- {í•­ëª©.get('ì§€ì§€', í•­ëª©)}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[ì§€ì§€ ì‚¼í•©]\n"
    if í•©ì¶©í˜•íŒŒí•´['ì‚¼í•©']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['ì‚¼í•©']:
            if isinstance(í•­ëª©, dict):
                text += f"- {í•­ëª©.get('ì§€ì§€', '')} â†’ {í•­ëª©.get('ì˜¤í–‰', '')}{'(ì™„ì„±)' if í•­ëª©.get('ì™„ì„±') else '(ë¯¸ì™„ì„±)'}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[ì§€ì§€ ë°©í•©]\n"
    if í•©ì¶©í˜•íŒŒí•´['ë°©í•©']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['ë°©í•©']:
            if isinstance(í•­ëª©, dict):
                ì§€ì§€_str = ','.join(í•­ëª©.get('ì§€ì§€', []))
                text += f"- {ì§€ì§€_str} â†’ {í•­ëª©.get('ì˜¤í–‰', '')}{'(ì™„ì„±)' if í•­ëª©.get('ì™„ì„±') else '(ë¯¸ì™„ì„±)'}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[ì¶©]\n"
    if í•©ì¶©í˜•íŒŒí•´['ì¶©']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['ì¶©']:
            if isinstance(í•­ëª©, dict):
                text += f"- {í•­ëª©.get('ìœ„ì¹˜', '')}: {í•­ëª©.get('ì§€ì§€', '')}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[í˜•]\n"
    if í•©ì¶©í˜•íŒŒí•´['í˜•']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['í˜•']:
            if isinstance(í•­ëª©, dict):
                text += f"- {í•­ëª©.get('ìœ„ì¹˜', '')}: {í•­ëª©.get('ì§€ì§€', '')}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[íŒŒ]\n"
    if í•©ì¶©í˜•íŒŒí•´['íŒŒ']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['íŒŒ']:
            if isinstance(í•­ëª©, dict):
                text += f"- {í•­ëª©.get('ìœ„ì¹˜', '')}: {í•­ëª©.get('ì§€ì§€', '')}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[í•´]\n"
    if í•©ì¶©í˜•íŒŒí•´['í•´']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['í•´']:
            if isinstance(í•­ëª©, dict):
                text += f"- {í•­ëª©.get('ìœ„ì¹˜', '')}: {í•­ëª©.get('ì§€ì§€', '')}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += f"""
â–  11. ê¶ì„±í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ë…„ì£¼: {ê¶ì„±['ë…„ì£¼']['ê¶']} - {ê¶ì„±['ë…„ì£¼']['ì˜ë¯¸']}
ì›”ì£¼: {ê¶ì„±['ì›”ì£¼']['ê¶']} - {ê¶ì„±['ì›”ì£¼']['ì˜ë¯¸']}
ì¼ì£¼: {ê¶ì„±['ì¼ì£¼']['ê¶']} - {ê¶ì„±['ì¼ì£¼']['ì˜ë¯¸']}
ì‹œì£¼: {ê¶ì„±['ì‹œì£¼']['ê¶']} - {ê¶ì„±['ì‹œì£¼']['ì˜ë¯¸']}

â–  12. ìœ¡ì¹œí‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    for ì£¼, ë°ì´í„° in ìœ¡ì¹œ.items():
        ì²œê°„_ìœ¡ì¹œ = ë°ì´í„°['ì²œê°„']['ìœ¡ì¹œ']
        ì§€ì§€_ìœ¡ì¹œ = ë°ì´í„°['ì§€ì§€']['ìœ¡ì¹œ']
        text += f"{ì£¼}ì£¼: ì²œê°„({ì²œê°„_ìœ¡ì¹œ}), ì§€ì§€({ì§€ì§€_ìœ¡ì¹œ})\n"
    
    text += f"""
â–  13. ë‚©ìŒì˜¤í–‰í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ë…„ì£¼({ë…„ì£¼[0]}{ë…„ì£¼[1]}): {ë‚©ìŒ['ë…„']['ë‚©ìŒ']} - {ë‚©ìŒ['ë…„']['ì„¤ëª…']}
ì›”ì£¼({ì›”ì£¼[0]}{ì›”ì£¼[1]}): {ë‚©ìŒ['ì›”']['ë‚©ìŒ']} - {ë‚©ìŒ['ì›”']['ì„¤ëª…']}
ì¼ì£¼({ì¼ì£¼[0]}{ì¼ì£¼[1]}): {ë‚©ìŒ['ì¼']['ë‚©ìŒ']} - {ë‚©ìŒ['ì¼']['ì„¤ëª…']}
ì‹œì£¼({ì‹œì£¼[0]}{ì‹œì£¼[1]}): {ë‚©ìŒ['ì‹œ']['ë‚©ìŒ']} - {ë‚©ìŒ['ì‹œ']['ì„¤ëª…']}

â–  14. ê²©êµ­í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì •ê²©: {ê²©êµ­['ì •ê²©']}
íŠ¹ìˆ˜ê²©: {', '.join(ê²©êµ­['íŠ¹ìˆ˜ê²©']) if ê²©êµ­['íŠ¹ìˆ˜ê²©'] else 'ì—†ìŒ'}
ì›”ì§€: {ê²©êµ­['ì›”ì§€']} (ë³¸ê¸°: {ê²©êµ­['ì›”ì§€_ë³¸ê¸°']})

â–  15. ê³µë§í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ë…„ì£¼ ê¸°ì¤€ ê³µë§: {ê³µë§['ë…„']['ê³µë§'][0]}, {ê³µë§['ë…„']['ê³µë§'][1]} ({ê³µë§['ë…„']['ìˆœ']})
ì¼ì£¼ ê¸°ì¤€ ê³µë§: {ê³µë§['ì¼']['ê³µë§'][0]}, {ê³µë§['ì¼']['ê³µë§'][1]} ({ê³µë§['ì¼']['ìˆœ']})
ì›êµ­ ë‚´ ê³µë§ í•´ë‹¹: {', '.join(ê³µë§['ê³µë§_í•´ë‹¹']) if ê³µë§['ê³µë§_í•´ë‹¹'] else 'ì—†ìŒ'}

â–  16. ìš©ì‹ í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ì‹ ê°•/ì‹ ì•½] {ìš©ì‹ _data['ì‹ ê°•ì•½']} ({ìš©ì‹ _data['ì‹ ê°•ì ìˆ˜']})

[ì¡°í›„ìš©ì‹ ] {ìš©ì‹ _data['ì¡°í›„_ìš©ì‹ ']}
[ì–µë¶€ìš©ì‹ ] {ìš©ì‹ _data['ì–µë¶€_ìš©ì‹ ']}
[í†µê´€ìš©ì‹ ] {ìš©ì‹ _data['í†µê´€_ìš©ì‹ '] if ìš©ì‹ _data['í†µê´€_ìš©ì‹ '] else 'ì—†ìŒ'}

[5ì‹ ]
ìš©ì‹ : {ìš©ì‹ _data['ìš©ì‹ ']}
í¬ì‹ : {ìš©ì‹ _data['í¬ì‹ ']}
í•œì‹ : {ìš©ì‹ _data['í•œì‹ ']}
ê¸°ì‹ : {ìš©ì‹ _data['ê¸°ì‹ ']}
êµ¬ì‹ : {ìš©ì‹ _data['êµ¬ì‹ ']}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–  [ì¶”ê°€ì •ë³´-ê³µí†µ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- ì§ì—…/ì—…ì¢…: 
- í˜„ì¬ ê°€ì¥ í° ê³ ë¯¼: 
- ìƒë‹´ ëª©ì : 
- ë¯¼ê°í•˜ê±°ë‚˜ í”¼í•˜ê³  ì‹¶ì€ ì£¼ì œ: 

â–  [ì¶”ê°€ì •ë³´-ì œnì¥] (í•„ìš”í•œ ì¥ ë²ˆí˜¸ë§Œ ì‚¬ìš©)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- ì´ ì¥ì—ì„œ ê¼­ ë‹¤ë¤„ì•¼ í•  ìƒí™©: 
- í˜„ì¬ ì‹œì /ê³„íš: 
- íŠ¹ë³„íˆ ë°˜ì˜í•  ì¡°ê±´: 

"""
    
    return text

# ============================================
# ìŒë ¥ â†’ ì–‘ë ¥ ë³€í™˜ í•¨ìˆ˜
# ============================================
def ìŒë ¥_to_ì–‘ë ¥(year, month, day, ìœ¤ë‹¬=False):
    """ìŒë ¥ ë‚ ì§œë¥¼ ì–‘ë ¥ìœ¼ë¡œ ë³€í™˜ (ìœ¤ë‹¬ ì§€ì›)"""
    calendar = KoreanLunarCalendar()
    calendar.setLunarDate(year, month, day, ìœ¤ë‹¬)
    return calendar.solarYear, calendar.solarMonth, calendar.solarDay

def ì–‘ë ¥_to_ìŒë ¥(year, month, day):
    """ì–‘ë ¥ ë‚ ì§œë¥¼ ìŒë ¥ìœ¼ë¡œ ë³€í™˜ (ìœ¤ë‹¬ ì—¬ë¶€ í¬í•¨)"""
    calendar = KoreanLunarCalendar()
    calendar.setSolarDate(year, month, day)
    ìœ¤ë‹¬ì—¬ë¶€ = calendar.isIntercalation
    return calendar.lunarYear, calendar.lunarMonth, calendar.lunarDay, ìœ¤ë‹¬ì—¬ë¶€

def ìŒë ¥_ë¬¸ìì—´(year, month, day, ìœ¤ë‹¬=False):
    """ìŒë ¥ ë‚ ì§œë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜ (ìœ¤ë‹¬ í‘œì‹œ í¬í•¨)"""
    ìœ¤_í‘œì‹œ = "ìœ¤" if ìœ¤ë‹¬ else ""
    return f"{year}-{ìœ¤_í‘œì‹œ}{month:02d}-{day:02d}"

# ============================================
# í˜ì´ì§€ ì„¤ì •
# ============================================
st.set_page_config(
    page_title="ì‚¬ì£¼ ì´ë¯¸ì§€ ìƒì„±ê¸°",
    page_icon="ğŸ”®",
    layout="wide"
)

st.title("ğŸ”® ì‚¬ì£¼/íƒ€ë¡œ/ì—°ì•  ì´ë¯¸ì§€ ìƒì„±ê¸°")

# ============================================
# ì‚¬ì´ë“œë°”
# ============================================
with st.sidebar:
    st.header("ğŸ”® ì„œë¹„ìŠ¤ ì„ íƒ")
    ì„œë¹„ìŠ¤ = st.radio(
        "ìƒì„±í•  ì´ë¯¸ì§€ ì¢…ë¥˜",
        ["ì‚¬ì£¼", "íƒ€ë¡œ (ì¤€ë¹„ì¤‘)", "ì—°ì• ìƒë‹´ (ì¤€ë¹„ì¤‘)"]
    )
    
    st.divider()
    
    st.header("ğŸ“Š ìƒì„±í•  ì´ë¯¸ì§€")
    
    # ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤
    ì „ì²´ì„ íƒ = st.checkbox("âœ… ì „ì²´ ì„ íƒ", value=True, key="select_all")
    
    st.divider()
    
    ì›êµ­í‘œ_ì²´í¬ = st.checkbox("ì›êµ­í‘œ", value=ì „ì²´ì„ íƒ)
    ëŒ€ìš´í‘œ_ì²´í¬ = st.checkbox("ëŒ€ìš´í‘œ", value=ì „ì²´ì„ íƒ)
    ì„¸ìš´í‘œ_ì²´í¬ = st.checkbox("ì„¸ìš´í‘œ", value=ì „ì²´ì„ íƒ)
    ì›”ìš´í‘œ_ì²´í¬ = st.checkbox("ì›”ìš´í‘œ", value=ì „ì²´ì„ íƒ)
    ì˜¤í–‰ì°¨íŠ¸_ì²´í¬ = st.checkbox("ì˜¤í–‰ ë¶„ì„", value=ì „ì²´ì„ íƒ)
    ì‹­ì„±í‘œ_ì²´í¬ = st.checkbox("ì‹­ì„±í‘œ", value=ì „ì²´ì„ íƒ)
    ì‹ ì‚´í‘œ_ì²´í¬ = st.checkbox("ì‹ ì‚´í‘œ", value=ì „ì²´ì„ íƒ)
    ìš´ì„±í‘œ_ì²´í¬ = st.checkbox("12ìš´ì„±í‘œ", value=ì „ì²´ì„ íƒ)
    ì§€ì¥ê°„í‘œ_ì²´í¬ = st.checkbox("ì§€ì¥ê°„í‘œ", value=ì „ì²´ì„ íƒ)
    í•©ì¶©í˜•íŒŒí•´í‘œ_ì²´í¬ = st.checkbox("í•©ì¶©í˜•íŒŒí•´í‘œ", value=ì „ì²´ì„ íƒ)
    ê¶ì„±í‘œ_ì²´í¬ = st.checkbox("ê¶ì„±í‘œ", value=ì „ì²´ì„ íƒ)
    ìœ¡ì¹œí‘œ_ì²´í¬ = st.checkbox("ìœ¡ì¹œí‘œ", value=ì „ì²´ì„ íƒ)
    ë‚©ìŒì˜¤í–‰í‘œ_ì²´í¬ = st.checkbox("ë‚©ìŒì˜¤í–‰í‘œ", value=ì „ì²´ì„ íƒ)
    ê²©êµ­í‘œ_ì²´í¬ = st.checkbox("ê²©êµ­í‘œ", value=ì „ì²´ì„ íƒ)
    ê³µë§í‘œ_ì²´í¬ = st.checkbox("ê³µë§í‘œ", value=ì „ì²´ì„ íƒ)
    ìš©ì‹ í‘œ_ì²´í¬ = st.checkbox("ìš©ì‹ í‘œ", value=ì „ì²´ì„ íƒ)
    
    st.divider()
    st.caption("v2.0 - í†µí•© ìë™í™” ì‹œìŠ¤í…œ")

# ============================================
# íƒ­ êµ¬ì„±
# ============================================
tab1, tab2, tab3, tab4, tab5 = st.tabs(["ğŸ“ ê°œë³„ ì…ë ¥", "ğŸ“Š ì—‘ì…€ ì¼ê´„", "ğŸ“… ì¼ì§„í‘œ", "ğŸ“„ ë³´ê³ ì„œ ìƒì„±", "ğŸ“§ ë°œì†¡ ê´€ë¦¬"])

# ============================================
# íƒ­1: ê°œë³„ ì…ë ¥
# ============================================
with tab1:
    st.subheader("ê³ ê° ì •ë³´ ì…ë ¥")
    
    # session_state ì´ˆê¸°í™”
    if 'input_ì´ë¦„' not in st.session_state:
        st.session_state.input_ì´ë¦„ = ""
    if 'input_ìƒë…„ì›”ì¼' not in st.session_state:
        st.session_state.input_ìƒë…„ì›”ì¼ = datetime(1990, 1, 1)
    if 'input_ì‹œ' not in st.session_state:
        st.session_state.input_ì‹œ = 12
    if 'input_ë¶„' not in st.session_state:
        st.session_state.input_ë¶„ = 0
    if 'input_ì„±ë³„' not in st.session_state:
        st.session_state.input_ì„±ë³„ = "ë‚¨ì„±"
    if 'input_ìŒì–‘ë ¥' not in st.session_state:
        st.session_state.input_ìŒì–‘ë ¥ = "ì–‘ë ¥"
    if 'input_ìœ¤ë‹¬' not in st.session_state:
        st.session_state.input_ìœ¤ë‹¬ = False
    if 'ìƒì„±ëœ_ì´ë¯¸ì§€' not in st.session_state:
        st.session_state.ìƒì„±ëœ_ì´ë¯¸ì§€ = {}
    
    col1, col2 = st.columns(2)
    
    with col1:
        ì´ë¦„ = st.text_input("ì´ë¦„", value=st.session_state.input_ì´ë¦„, placeholder="í™ê¸¸ë™", key="name_input")
        ì„±ë³„ = st.radio("ì„±ë³„", ["ë‚¨ì„±", "ì—¬ì„±"], horizontal=True, index=0 if st.session_state.input_ì„±ë³„ == "ë‚¨ì„±" else 1)
        ìƒë…„ì›”ì¼ = st.date_input(
            "ìƒë…„ì›”ì¼", 
            st.session_state.input_ìƒë…„ì›”ì¼,
            min_value=datetime(1900, 1, 1),
            max_value=datetime(2030, 12, 31)
        )
    
    with col2:
        ì‹œê°„_col1, ì‹œê°„_col2 = st.columns(2)
        with ì‹œê°„_col1:
            ì‹œ = st.number_input("ì‹œ", min_value=0, max_value=23, value=st.session_state.input_ì‹œ)
        with ì‹œê°„_col2:
            ë¶„ = st.number_input("ë¶„", min_value=0, max_value=59, value=st.session_state.input_ë¶„)
        
        # ìŒë ¥/ì–‘ë ¥ + ìœ¤ë‹¬ ì²´í¬ë°•ìŠ¤ë¥¼ í•œ ì¤„ì— ë°°ì¹˜
        ìŒì–‘ë ¥ = st.radio("ìŒë ¥/ì–‘ë ¥", ["ì–‘ë ¥", "ìŒë ¥"], horizontal=True, index=0 if st.session_state.input_ìŒì–‘ë ¥ == "ì–‘ë ¥" else 1)
        
        # ìŒë ¥ ì„ íƒ ì‹œì—ë§Œ ìœ¤ë‹¬ ì²´í¬ë°•ìŠ¤ í‘œì‹œ (ë°”ë¡œ ì•„ë˜ì—)
        if ìŒì–‘ë ¥ == "ìŒë ¥":
            ìœ¤ë‹¬ = st.checkbox("â˜‘ ìœ¤ë‹¬ (ìŒë ¥ ìƒì¼ì´ ìœ¤ë‹¬ì¸ ê²½ìš° ì²´í¬)", value=st.session_state.input_ìœ¤ë‹¬)
        else:
            ìœ¤ë‹¬ = False
    
    st.divider()
    
    # ë²„íŠ¼ ì˜ì—­ (ì´ë¯¸ì§€ ìƒì„± + GPTìš© í…ìŠ¤íŠ¸ + ì´ˆê¸°í™”)
    btn_col1, btn_col2, btn_col3 = st.columns([2, 2, 1])
    
    with btn_col1:
        ìƒì„±_ë²„íŠ¼ = st.button("ğŸ¯ ì´ë¯¸ì§€ ìƒì„±", type="primary", use_container_width=True)
    
    with btn_col2:
        GPT_ë²„íŠ¼ = st.button("ğŸ“‹ GPTìš© í…ìŠ¤íŠ¸", type="secondary", use_container_width=True)
    
    with btn_col3:
        ì´ˆê¸°í™”_ë²„íŠ¼ = st.button("ğŸ”„ ì´ˆê¸°í™”", type="secondary", use_container_width=True)
    
    # ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ
    if ì´ˆê¸°í™”_ë²„íŠ¼:
        st.session_state.input_ì´ë¦„ = ""
        st.session_state.input_ìƒë…„ì›”ì¼ = datetime(1990, 1, 1)
        st.session_state.input_ì‹œ = 12
        st.session_state.input_ë¶„ = 0
        st.session_state.input_ì„±ë³„ = "ë‚¨ì„±"
        st.session_state.input_ìŒì–‘ë ¥ = "ì–‘ë ¥"
        st.session_state.input_ìœ¤ë‹¬ = False
        st.session_state.ìƒì„±ëœ_ì´ë¯¸ì§€ = {}
        if 'gpt_text' in st.session_state:
            del st.session_state.gpt_text
        st.rerun()
    
    # GPTìš© í…ìŠ¤íŠ¸ ë²„íŠ¼ í´ë¦­ ì‹œ
    if GPT_ë²„íŠ¼:
        if not ì´ë¦„:
            st.error("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            with st.spinner("GPTìš© í…ìŠ¤íŠ¸ ìƒì„± ì¤‘..."):
                # ì…ë ¥ ë‚ ì§œ
                input_year = ìƒë…„ì›”ì¼.year
                input_month = ìƒë…„ì›”ì¼.month
                input_day = ìƒë…„ì›”ì¼.day
                
                # ìŒë ¥/ì–‘ë ¥ ë³€í™˜ (ìœ¤ë‹¬ ì§€ì›)
                if ìŒì–‘ë ¥ == "ìŒë ¥":
                    year, month, day = ìŒë ¥_to_ì–‘ë ¥(input_year, input_month, input_day, ìœ¤ë‹¬)
                    ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(input_year, input_month, input_day, ìœ¤ë‹¬)
                    ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {ì‹œ:02d}:{ë¶„:02d}"
                else:
                    year, month, day = input_year, input_month, input_day
                    ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {ì‹œ:02d}:{ë¶„:02d}"
                    ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬ = ì–‘ë ¥_to_ìŒë ¥(year, month, day)
                    ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬)
                
                # ì‚¬ì£¼ ê³„ì‚°
                ì‚¬ì£¼ = calc_ì‚¬ì£¼(year, month, day, ì‹œ, ë¶„)
                
                # ë‚˜ì´ ê³„ì‚°
                today = datetime.now()
                ë‚˜ì´ = today.year - year + 1
                
                # ê¸°ë³¸ì •ë³´
                ê¸°ë³¸ì •ë³´ = {
                    'ì´ë¦„': ì´ë¦„,
                    'ì„±ë³„': ì„±ë³„,
                    'ë‚˜ì´': ë‚˜ì´,
                    'ì–‘ë ¥': ì–‘ë ¥_str,
                    'ìŒë ¥': ìŒë ¥_str,
                }
                
                gender = 'ë‚¨' if ì„±ë³„ == 'ë‚¨ì„±' else 'ì—¬'
                ì‹ ì‚´_data = calc_ì‹ ì‚´(ì‚¬ì£¼, gender)
                ëŒ€ìš´_data = calc_ëŒ€ìš´(year, month, day, ì‹œ, ë¶„, gender)
                ì„¸ìš´_data = calc_ì„¸ìš´(year, month, day, ì‹œ, ë¶„)
                ì›”ìš´_data = calc_ì›”ìš´(year, month, day, ì‹œ, ë¶„)
                
                # GPTìš© í…ìŠ¤íŠ¸ ìƒì„±
                gpt_text = generate_gpt_text(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, gender, ëŒ€ìš´_data, ì„¸ìš´_data, ì›”ìš´_data, ì‹ ì‚´_data)
                st.session_state.gpt_text = gpt_text
                st.session_state.gpt_ì´ë¦„ = ì´ë¦„
    
    # GPTìš© í…ìŠ¤íŠ¸ í‘œì‹œ
    if 'gpt_text' in st.session_state:
        st.divider()
        st.subheader(f"ğŸ“‹ {st.session_state.gpt_ì´ë¦„}ë‹˜ GPTìš© ë°ì´í„°")
        
        # ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì»¨í…Œì´ë„ˆ (height ì œí•œ)
        with st.container(height=300):
            st.code(st.session_state.gpt_text, language=None)
        
        st.download_button(
            label="ğŸ“¥ í…ìŠ¤íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
            data=st.session_state.gpt_text,
            file_name=f"{st.session_state.gpt_ì´ë¦„}_ì‚¬ì£¼ë°ì´í„°.txt",
            mime="text/plain",
            use_container_width=True
        )
    
    if ìƒì„±_ë²„íŠ¼:
        if not ì´ë¦„:
            st.error("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            with st.spinner("ì´ë¯¸ì§€ ìƒì„± ì¤‘..."):
                # ì…ë ¥ ë‚ ì§œ
                input_year = ìƒë…„ì›”ì¼.year
                input_month = ìƒë…„ì›”ì¼.month
                input_day = ìƒë…„ì›”ì¼.day
                
                # ìŒë ¥/ì–‘ë ¥ ë³€í™˜ (ìœ¤ë‹¬ ì§€ì›)
                if ìŒì–‘ë ¥ == "ìŒë ¥":
                    year, month, day = ìŒë ¥_to_ì–‘ë ¥(input_year, input_month, input_day, ìœ¤ë‹¬)
                    ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(input_year, input_month, input_day, ìœ¤ë‹¬)
                    ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {ì‹œ:02d}:{ë¶„:02d}"
                else:
                    year, month, day = input_year, input_month, input_day
                    ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {ì‹œ:02d}:{ë¶„:02d}"
                    ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬ = ì–‘ë ¥_to_ìŒë ¥(year, month, day)
                    ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬)
                
                # ì‚¬ì£¼ ê³„ì‚°
                ì‚¬ì£¼ = calc_ì‚¬ì£¼(year, month, day, ì‹œ, ë¶„)
                
                # ë‚˜ì´ ê³„ì‚°
                today = datetime.now()
                ë‚˜ì´ = today.year - year + 1
                
                # ê¸°ë³¸ì •ë³´
                ê¸°ë³¸ì •ë³´ = {
                    'ì´ë¦„': ì´ë¦„,
                    'ì„±ë³„': ì„±ë³„,
                    'ë‚˜ì´': ë‚˜ì´,
                    'ì–‘ë ¥': ì–‘ë ¥_str,
                    'ìŒë ¥': ìŒë ¥_str,
                }
                
                gender = 'ë‚¨' if ì„±ë³„ == 'ë‚¨ì„±' else 'ì—¬'
                ì‹ ì‚´_data = calc_ì‹ ì‚´(ì‚¬ì£¼, gender)
                
                # ìƒì„±ëœ ì´ë¯¸ì§€ ê²½ë¡œ ì €ì¥ (session_stateì— ì €ì¥)
                ìƒì„±ëœ_ì´ë¯¸ì§€ = {}
                
                # ì²´í¬ëœ ì´ë¯¸ì§€ë§Œ ìƒì„±
                if ì›êµ­í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ì›êµ­í‘œ.png"
                    create_ì›êµ­í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path, ì‹ ì‚´_data, ZODIAC_PATH)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['01_ì›êµ­í‘œ'] = path
                
                if ëŒ€ìš´í‘œ_ì²´í¬:
                    ëŒ€ìš´_data = calc_ëŒ€ìš´(year, month, day, ì‹œ, ë¶„, gender)
                    path = f"/tmp/{ì´ë¦„}_ëŒ€ìš´í‘œ.png"
                    create_ëŒ€ìš´í‘œ(ëŒ€ìš´_data, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['02_ëŒ€ìš´í‘œ'] = path
                
                if ì„¸ìš´í‘œ_ì²´í¬:
                    ì„¸ìš´_data = calc_ì„¸ìš´(year, month, day, ì‹œ, ë¶„)
                    path = f"/tmp/{ì´ë¦„}_ì„¸ìš´í‘œ.png"
                    create_ì„¸ìš´í‘œ(ì„¸ìš´_data, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['03_ì„¸ìš´í‘œ'] = path
                
                if ì›”ìš´í‘œ_ì²´í¬:
                    ì›”ìš´_data = calc_ì›”ìš´(year, month, day, ì‹œ, ë¶„)
                    path = f"/tmp/{ì´ë¦„}_ì›”ìš´í‘œ.png"
                    create_ì›”ìš´í‘œ(ì›”ìš´_data, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['04_ì›”ìš´í‘œ'] = path
                
                if ì˜¤í–‰ì°¨íŠ¸_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ì˜¤í–‰ë¶„ì„.png"
                    create_ì˜¤í–‰ì°¨íŠ¸(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['05_ì˜¤í–‰ë¶„ì„'] = path
                
                if ì‹­ì„±í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ì‹­ì„±í‘œ.png"
                    create_ì‹­ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['06_ì‹­ì„±í‘œ'] = path
                
                if ì‹ ì‚´í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ì‹ ì‚´í‘œ.png"
                    create_ì‹ ì‚´í‘œ(ì‹ ì‚´_data, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['07_ì‹ ì‚´í‘œ'] = path
                
                if ìš´ì„±í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_12ìš´ì„±í‘œ.png"
                    create_12ìš´ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['08_12ìš´ì„±í‘œ'] = path
                
                if ì§€ì¥ê°„í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ì§€ì¥ê°„í‘œ.png"
                    create_ì§€ì¥ê°„í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['09_ì§€ì¥ê°„í‘œ'] = path
                
                if í•©ì¶©í˜•íŒŒí•´í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_í•©ì¶©í˜•íŒŒí•´í‘œ.png"
                    create_í•©ì¶©í˜•íŒŒí•´í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['10_í•©ì¶©í˜•íŒŒí•´í‘œ'] = path
                
                if ê¶ì„±í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ê¶ì„±í‘œ.png"
                    create_ê¶ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['11_ê¶ì„±í‘œ'] = path
                
                if ìœ¡ì¹œí‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ìœ¡ì¹œí‘œ.png"
                    create_ìœ¡ì¹œí‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, gender, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['12_ìœ¡ì¹œí‘œ'] = path
                
                if ë‚©ìŒì˜¤í–‰í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ë‚©ìŒì˜¤í–‰í‘œ.png"
                    create_ë‚©ìŒì˜¤í–‰í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['13_ë‚©ìŒì˜¤í–‰í‘œ'] = path
                
                if ê²©êµ­í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ê²©êµ­í‘œ.png"
                    create_ê²©êµ­í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['14_ê²©êµ­í‘œ'] = path
                
                if ê³µë§í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ê³µë§í‘œ.png"
                    create_ê³µë§í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['15_ê³µë§í‘œ'] = path
                
                if ìš©ì‹ í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ìš©ì‹ í‘œ.png"
                    create_ìš©ì‹ í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['16_ìš©ì‹ í‘œ'] = path
                
                st.success(f"âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ! ({len(ìƒì„±ëœ_ì´ë¯¸ì§€)}ê°œ)")
                
                # ============================================
                # ì „ì²´ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ìƒë‹¨)
                # ============================================
                if len(ìƒì„±ëœ_ì´ë¯¸ì§€) > 0:
                    zip_buffer = io.BytesIO()
                    with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zf:
                        for íŒŒì¼ëª…, ê²½ë¡œ in ìƒì„±ëœ_ì´ë¯¸ì§€.items():
                            zf.write(ê²½ë¡œ, f"{íŒŒì¼ëª…}.png")
                    
                    zip_buffer.seek(0)
                    st.download_button(
                        label=f"ğŸ“¦ ì „ì²´ ë‹¤ìš´ë¡œë“œ ({len(ìƒì„±ëœ_ì´ë¯¸ì§€)}ê°œ ZIP)",
                        data=zip_buffer,
                        file_name=f"{ì´ë¦„}_ì‚¬ì£¼ë¶„ì„.zip",
                        mime="application/zip",
                        use_container_width=True,
                        key="download_ì „ì²´_zip"
                    )
                
                st.divider()
                
                # ============================================
                # ê°œë³„ ì´ë¯¸ì§€ í‘œì‹œ
                # ============================================
                if '01_ì›êµ­í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ“Š ì›êµ­í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['01_ì›êµ­í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ì›êµ­í‘œ")
                
                if '02_ëŒ€ìš´í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ“ˆ ëŒ€ìš´í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['02_ëŒ€ìš´í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ëŒ€ìš´í‘œ")
                
                if '03_ì„¸ìš´í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ“… ì„¸ìš´í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['03_ì„¸ìš´í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ì„¸ìš´í‘œ")
                
                if '04_ì›”ìš´í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ—“ï¸ ì›”ìš´í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['04_ì›”ìš´í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ì›”ìš´í‘œ")
                
                if '05_ì˜¤í–‰ë¶„ì„' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ”¥ ì˜¤í–‰ ë¶„ì„")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['05_ì˜¤í–‰ë¶„ì„'], caption=f"{ì´ë¦„}ë‹˜ ì˜¤í–‰ë¶„ì„")
                
                if '06_ì‹­ì„±í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("â­ ì‹­ì„±í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['06_ì‹­ì„±í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ì‹­ì„±í‘œ")
                
                if '07_ì‹ ì‚´í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ”® ì‹ ì‚´í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['07_ì‹ ì‚´í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ì‹ ì‚´í‘œ")
                
                if '08_12ìš´ì„±í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ”„ 12ìš´ì„±í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['08_12ìš´ì„±í‘œ'], caption=f"{ì´ë¦„}ë‹˜ 12ìš´ì„±í‘œ")
                
                if '09_ì§€ì¥ê°„í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ“‹ ì§€ì¥ê°„í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['09_ì§€ì¥ê°„í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ì§€ì¥ê°„í‘œ")
                
                if '10_í•©ì¶©í˜•íŒŒí•´í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("âš¡ í•©ì¶©í˜•íŒŒí•´í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['10_í•©ì¶©í˜•íŒŒí•´í‘œ'], caption=f"{ì´ë¦„}ë‹˜ í•©ì¶©í˜•íŒŒí•´í‘œ")
                
                if '11_ê¶ì„±í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ  ê¶ì„±í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['11_ê¶ì„±í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ê¶ì„±í‘œ")
                
                if '12_ìœ¡ì¹œí‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ìœ¡ì¹œí‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['12_ìœ¡ì¹œí‘œ'], caption=f"{ì´ë¦„}ë‹˜ ìœ¡ì¹œí‘œ")
                
                if '13_ë‚©ìŒì˜¤í–‰í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸµ ë‚©ìŒì˜¤í–‰í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['13_ë‚©ìŒì˜¤í–‰í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ë‚©ìŒì˜¤í–‰í‘œ")
                
                if '14_ê²©êµ­í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ¯ ê²©êµ­í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['14_ê²©êµ­í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ê²©êµ­í‘œ")
                
                if '15_ê³µë§í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ•³ï¸ ê³µë§í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['15_ê³µë§í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ê³µë§í‘œ")
                
                if '16_ìš©ì‹ í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ¯ ìš©ì‹ í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['16_ìš©ì‹ í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ìš©ì‹ í‘œ")

# ============================================
# íƒ­2: ì—‘ì…€ ì¼ê´„ ì²˜ë¦¬
# ============================================
with tab2:
    st.subheader("ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ")
    
    # ìƒ˜í”Œ ë‹¤ìš´ë¡œë“œ
    sample_data = {
        'ì´ë¦„': ['í™ê¸¸ë™', 'ê¹€ì² ìˆ˜'],
        'ì„±ë³„': ['ë‚¨ì„±', 'ì—¬ì„±'],
        'ìƒë…„': [1990, 1985],
        'ìƒì›”': [5, 12],
        'ìƒì¼': [15, 3],
        'ì‹œ': [14, 8],
        'ë¶„': [30, 0],
        'ìŒì–‘ë ¥': ['ì–‘ë ¥', 'ìŒë ¥'],
        'ìœ¤ë‹¬': ['', 'O'],  # ìŒë ¥ì¼ ë•Œë§Œ O í‘œì‹œ
    }
    sample_df = pd.DataFrame(sample_data)
    
    buffer = io.BytesIO()
    sample_df.to_excel(buffer, index=False, engine='openpyxl')
    buffer.seek(0)
    
    st.download_button(
        label="ğŸ“‹ ìƒ˜í”Œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ",
        data=buffer,
        file_name="sample_input.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )
    
    st.info("ğŸ’¡ **ìœ¤ë‹¬ ì…ë ¥ ë°©ë²•**: ìŒë ¥ ìƒì¼ì´ ìœ¤ë‹¬ì¸ ê²½ìš° 'ìœ¤ë‹¬' ì»¬ëŸ¼ì— 'O' ì…ë ¥")
    
    st.divider()
    
    uploaded_file = st.file_uploader("ì—‘ì…€ íŒŒì¼ ì„ íƒ", type=['xlsx', 'xls'])
    
    if uploaded_file:
        df = pd.read_excel(uploaded_file)
        
        # ìœ¤ë‹¬ ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ì¶”ê°€
        if 'ìœ¤ë‹¬' not in df.columns:
            df['ìœ¤ë‹¬'] = ''
        
        st.write(f"**{len(df)}ëª… ë°ì´í„° í™•ì¸:**")
        st.dataframe(df, use_container_width=True)
        
        if st.button("ğŸ¯ ì¼ê´„ ìƒì„±", type="primary", use_container_width=True):
            progress = st.progress(0)
            status = st.empty()
            
            zip_buffer = io.BytesIO()
            
            with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zf:
                for idx, row in df.iterrows():
                    status.text(f"ì²˜ë¦¬ ì¤‘: {row['ì´ë¦„']} ({idx+1}/{len(df)})")
                    
                    input_year = int(row['ìƒë…„'])
                    input_month = int(row['ìƒì›”'])
                    input_day = int(row['ìƒì¼'])
                    
                    # ìœ¤ë‹¬ ì—¬ë¶€ í™•ì¸ (O, o, â—‹, 1, True ë“±)
                    ìœ¤ë‹¬_ê°’ = str(row.get('ìœ¤ë‹¬', '')).strip().upper()
                    ìœ¤ë‹¬ = ìœ¤ë‹¬_ê°’ in ['O', 'â—‹', '1', 'TRUE', 'Y', 'YES', 'ìœ¤ë‹¬']
                    
                    if row['ìŒì–‘ë ¥'] == "ìŒë ¥":
                        year, month, day = ìŒë ¥_to_ì–‘ë ¥(input_year, input_month, input_day, ìœ¤ë‹¬)
                        ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(input_year, input_month, input_day, ìœ¤ë‹¬)
                        ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {int(row['ì‹œ']):02d}:{int(row['ë¶„']):02d}"
                    else:
                        year, month, day = input_year, input_month, input_day
                        ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {int(row['ì‹œ']):02d}:{int(row['ë¶„']):02d}"
                        ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬ = ì–‘ë ¥_to_ìŒë ¥(year, month, day)
                        ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬)
                    
                    ì‚¬ì£¼ = calc_ì‚¬ì£¼(year, month, day, int(row['ì‹œ']), int(row['ë¶„']))
                    ë‚˜ì´ = datetime.now().year - year + 1
                    
                    ê¸°ë³¸ì •ë³´ = {
                        'ì´ë¦„': row['ì´ë¦„'],
                        'ì„±ë³„': row['ì„±ë³„'],
                        'ë‚˜ì´': ë‚˜ì´,
                        'ì–‘ë ¥': ì–‘ë ¥_str,
                        'ìŒë ¥': ìŒë ¥_str,
                    }
                    
                    gender = 'ë‚¨' if row['ì„±ë³„'] == 'ë‚¨ì„±' else 'ì—¬'
                    ì‹ ì‚´_data = calc_ì‹ ì‚´(ì‚¬ì£¼, gender)
                    
                    folder_name = f"{row['ì´ë¦„']}_{row['ìƒë…„']}-{row['ìƒì›”']:02d}-{row['ìƒì¼']:02d}"
                    
                    # ì²´í¬ëœ ì´ë¯¸ì§€ë§Œ ìƒì„±
                    if ì›êµ­í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ì›êµ­í‘œ.png"
                        create_ì›êµ­í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path, ì‹ ì‚´_data, ZODIAC_PATH)
                        zf.write(path, f"{folder_name}/01_ì›êµ­í‘œ.png")
                    
                    if ëŒ€ìš´í‘œ_ì²´í¬:
                        ëŒ€ìš´_data = calc_ëŒ€ìš´(year, month, day, int(row['ì‹œ']), int(row['ë¶„']), gender)
                        path = f"/tmp/{row['ì´ë¦„']}_ëŒ€ìš´í‘œ.png"
                        create_ëŒ€ìš´í‘œ(ëŒ€ìš´_data, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/02_ëŒ€ìš´í‘œ.png")
                    
                    if ì„¸ìš´í‘œ_ì²´í¬:
                        ì„¸ìš´_data = calc_ì„¸ìš´(year, month, day, int(row['ì‹œ']), int(row['ë¶„']))
                        path = f"/tmp/{row['ì´ë¦„']}_ì„¸ìš´í‘œ.png"
                        create_ì„¸ìš´í‘œ(ì„¸ìš´_data, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/03_ì„¸ìš´í‘œ.png")
                    
                    if ì›”ìš´í‘œ_ì²´í¬:
                        ì›”ìš´_data = calc_ì›”ìš´(year, month, day, int(row['ì‹œ']), int(row['ë¶„']))
                        path = f"/tmp/{row['ì´ë¦„']}_ì›”ìš´í‘œ.png"
                        create_ì›”ìš´í‘œ(ì›”ìš´_data, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/04_ì›”ìš´í‘œ.png")
                    
                    if ì˜¤í–‰ì°¨íŠ¸_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ì˜¤í–‰ë¶„ì„.png"
                        create_ì˜¤í–‰ì°¨íŠ¸(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/05_ì˜¤í–‰ë¶„ì„.png")
                    
                    if ì‹­ì„±í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ì‹­ì„±í‘œ.png"
                        create_ì‹­ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/06_ì‹­ì„±í‘œ.png")
                    
                    if ì‹ ì‚´í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ì‹ ì‚´í‘œ.png"
                        create_ì‹ ì‚´í‘œ(ì‹ ì‚´_data, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/07_ì‹ ì‚´í‘œ.png")
                    
                    if ìš´ì„±í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_12ìš´ì„±í‘œ.png"
                        create_12ìš´ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/08_12ìš´ì„±í‘œ.png")
                    
                    if ì§€ì¥ê°„í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ì§€ì¥ê°„í‘œ.png"
                        create_ì§€ì¥ê°„í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/09_ì§€ì¥ê°„í‘œ.png")
                    
                    if í•©ì¶©í˜•íŒŒí•´í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_í•©ì¶©í˜•íŒŒí•´í‘œ.png"
                        create_í•©ì¶©í˜•íŒŒí•´í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/10_í•©ì¶©í˜•íŒŒí•´í‘œ.png")
                    
                    if ê¶ì„±í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ê¶ì„±í‘œ.png"
                        create_ê¶ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/11_ê¶ì„±í‘œ.png")
                    
                    if ìœ¡ì¹œí‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ìœ¡ì¹œí‘œ.png"
                        create_ìœ¡ì¹œí‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, gender, path)
                        zf.write(path, f"{folder_name}/12_ìœ¡ì¹œí‘œ.png")
                    
                    if ë‚©ìŒì˜¤í–‰í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ë‚©ìŒì˜¤í–‰í‘œ.png"
                        create_ë‚©ìŒì˜¤í–‰í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/13_ë‚©ìŒì˜¤í–‰í‘œ.png")
                    
                    if ê²©êµ­í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ê²©êµ­í‘œ.png"
                        create_ê²©êµ­í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/14_ê²©êµ­í‘œ.png")
                    
                    if ê³µë§í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ê³µë§í‘œ.png"
                        create_ê³µë§í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/15_ê³µë§í‘œ.png")
                    
                    if ìš©ì‹ í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ìš©ì‹ í‘œ.png"
                        create_ìš©ì‹ í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/16_ìš©ì‹ í‘œ.png")
                    
                    progress.progress((idx + 1) / len(df))
            
            status.text("âœ… ì™„ë£Œ!")
            
            zip_buffer.seek(0)
            st.download_button(
                label="ğŸ“¥ ì „ì²´ ë‹¤ìš´ë¡œë“œ (ZIP)",
                data=zip_buffer,
                file_name="ì‚¬ì£¼_ì´ë¯¸ì§€_ê²°ê³¼.zip",
                mime="application/zip",
                use_container_width=True
            )

# ============================================
# íƒ­3: ì¼ì§„í‘œ
# ============================================
with tab3:
    st.subheader("ğŸ“… ì¼ì§„í‘œ ìƒì„±")
    st.write("12ê°œì›”ì¹˜ ì¼ì§„í‘œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.")
    
    col1, col2 = st.columns(2)
    
    with col1:
        ì¼ì§„_ì´ë¦„ = st.text_input("ì´ë¦„ (ì„ íƒ)", placeholder="í™ê¸¸ë™", key="ilzin_name")
    
    with col2:
        ì¼ì§„_ë…„ë„ = st.number_input("ë…„ë„", min_value=1900, max_value=2100, value=datetime.now().year, key="ilzin_year")
    
    # ì‹œì‘ ì›” ì„ íƒ
    ì‹œì‘ì›” = st.selectbox("ì‹œì‘ ì›”", range(1, 13), index=datetime.now().month - 1, key="ilzin_start_month")
    
    st.divider()
    
    if st.button("ğŸ“… ì¼ì§„í‘œ ìƒì„±", type="primary", use_container_width=True, key="btn_ilzin"):
        with st.spinner("ì¼ì§„í‘œ ìƒì„± ì¤‘..."):
            
            # ê¸°ë³¸ì •ë³´ (ì´ë¦„ì´ ìˆì„ ê²½ìš°)
            ê¸°ë³¸ì •ë³´ = {'ì´ë¦„': ì¼ì§„_ì´ë¦„} if ì¼ì§„_ì´ë¦„ else None
            
            # 12ê°œì›”ì¹˜ ìƒì„±
            ìƒì„±ëœ_ì¼ì§„ = {}
            
            for i in range(12):
                # ì›” ê³„ì‚° (ì‹œì‘ì›”ë¶€í„° 12ê°œì›”)
                target_month = ì‹œì‘ì›” + i
                target_year = ì¼ì§„_ë…„ë„
                
                if target_month > 12:
                    target_month -= 12
                    target_year += 1
                
                íŒŒì¼ëª… = f"{target_year}ë…„_{target_month:02d}ì›”_ì¼ì§„í‘œ"
                path = f"/tmp/{íŒŒì¼ëª…}.png"
                
                create_ì¼ì§„í‘œ(target_year, target_month, ê¸°ë³¸ì •ë³´=ê¸°ë³¸ì •ë³´, output_path=path)
                ìƒì„±ëœ_ì¼ì§„[íŒŒì¼ëª…] = path
            
            st.success(f"âœ… ì¼ì§„í‘œ 12ê°œì›” ìƒì„± ì™„ë£Œ!")
            
            # ============================================
            # ì „ì²´ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ìƒë‹¨)
            # ============================================
            zip_buffer = io.BytesIO()
            with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zf:
                for íŒŒì¼ëª…, ê²½ë¡œ in ìƒì„±ëœ_ì¼ì§„.items():
                    zf.write(ê²½ë¡œ, f"{íŒŒì¼ëª…}.png")
            
            zip_buffer.seek(0)
            
            ë‹¤ìš´ë¡œë“œ_íŒŒì¼ëª… = f"{ì¼ì§„_ì´ë¦„}_ì¼ì§„í‘œ_12ê°œì›”.zip" if ì¼ì§„_ì´ë¦„ else f"{ì¼ì§„_ë…„ë„}ë…„_ì¼ì§„í‘œ_12ê°œì›”.zip"
            
            st.download_button(
                label="ğŸ“¦ ì „ì²´ ë‹¤ìš´ë¡œë“œ (12ê°œì›” ZIP)",
                data=zip_buffer,
                file_name=ë‹¤ìš´ë¡œë“œ_íŒŒì¼ëª…,
                mime="application/zip",
                use_container_width=True,
                key="download_ì¼ì§„_zip"
            )
            
            st.divider()
            
            # ============================================
            # ê°œë³„ ì›” ì´ë¯¸ì§€ í‘œì‹œ
            # ============================================
            for íŒŒì¼ëª…, ê²½ë¡œ in ìƒì„±ëœ_ì¼ì§„.items():
                st.subheader(f"ğŸ“… {íŒŒì¼ëª….replace('_', ' ')}")
                st.image(ê²½ë¡œ, caption=íŒŒì¼ëª…)

# ============================================
# íƒ­4: ë³´ê³ ì„œ ìƒì„± (ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸ ë°©ì‹)
# ============================================
with tab4:
    st.subheader("ğŸ“„ ì‚¬ì£¼ ë³´ê³ ì„œ ìë™ ìƒì„± (150í˜ì´ì§€)")
    
    if not MODULES_AVAILABLE:
        st.error(f"âš ï¸ ì¶”ê°€ ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨: {IMPORT_ERROR}")
        st.code("pip install anthropic python-docx reportlab", language="bash")
        st.stop()
    
    st.info("""
    **ìë™ ë³´ê³ ì„œ ìƒì„± íë¦„**
    1. ê³ ê° ì •ë³´ ì…ë ¥ â†’ ì‚¬ì£¼ ê³„ì‚° â†’ ì´ë¯¸ì§€ 17ì¢… ìƒì„±
    2. ì¥ ë²”ìœ„ ì„ íƒ (1~3ì¥, 4~6ì¥, ...)
    3. Claude APIë¡œ ì¥ë³„ í•´ì„ ìƒì„± (ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸)
    4. Docx íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    """)
    
    # ============================================
    # ì„¤ì • ì˜ì—­
    # ============================================
    with st.expander("âš™ï¸ API ì„¤ì •", expanded=True):
        api_key = st.text_input(
            "ğŸ”‘ Anthropic API Key",
            type="password",
            placeholder="sk-ant-...",
            help="console.anthropic.comì—ì„œ ë°œê¸‰"
        )
        
        model_col, _ = st.columns([1, 1])
        with model_col:
            selected_model = st.selectbox(
                "ğŸ¤– ëª¨ë¸",
                options=["claude-sonnet-4-20250514", "claude-haiku-3-5-20241022"],
                format_func=lambda x: "Sonnet 4 (ì¶”ì²œ)" if "sonnet" in x else "Haiku 3.5 (ì €ë ´)"
            )
    
    st.divider()
    
    # ============================================
    # ê³ ê° ì •ë³´
    # ============================================
    st.subheader("ğŸ‘¤ ê³ ê° ì •ë³´")
    
    r_col1, r_col2 = st.columns(2)
    
    with r_col1:
        r_ì´ë¦„ = st.text_input("ì´ë¦„", placeholder="í™ê¸¸ë™", key="report_name")
        r_ì„±ë³„ = st.radio("ì„±ë³„", ["ë‚¨ì„±", "ì—¬ì„±"], horizontal=True, key="report_gender")
        r_ìƒë…„ì›”ì¼ = st.date_input(
            "ìƒë…„ì›”ì¼",
            datetime(1990, 1, 1),
            min_value=datetime(1900, 1, 1),
            max_value=datetime(2030, 12, 31),
            key="report_birth"
        )
    
    with r_col2:
        r_ì‹œ_col, r_ë¶„_col = st.columns(2)
        with r_ì‹œ_col:
            r_ì‹œ = st.number_input("ì‹œ", min_value=0, max_value=23, value=12, key="report_hour")
        with r_ë¶„_col:
            r_ë¶„ = st.number_input("ë¶„", min_value=0, max_value=59, value=0, key="report_min")
        
        r_ìŒì–‘ë ¥ = st.radio("ìŒë ¥/ì–‘ë ¥", ["ì–‘ë ¥", "ìŒë ¥"], horizontal=True, key="report_calendar")
        
        if r_ìŒì–‘ë ¥ == "ìŒë ¥":
            r_ìœ¤ë‹¬ = st.checkbox("â˜‘ ìœ¤ë‹¬", key="report_leap")
        else:
            r_ìœ¤ë‹¬ = False
    
    # ============================================
    # ì¥ ë²”ìœ„ ì„ íƒ (ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸ ë°©ì‹)
    # ============================================
    st.divider()
    st.subheader("ğŸ“ ìƒì„±í•  ì¥ ì„ íƒ")
    
    # ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸ ë¡œë“œ
    prompts_dir = os.path.join(os.path.dirname(__file__), "prompts")
    master_prompt_path = os.path.join(prompts_dir, "00_master_prompt.txt")
    
    master_prompt = None
    if os.path.exists(master_prompt_path):
        with open(master_prompt_path, 'r', encoding='utf-8') as f:
            master_prompt = f.read()
        st.success("âœ… ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸ ë¡œë“œë¨")
    else:
        st.error("âŒ prompts/00_ë§ˆìŠ¤í„°í”„ë¡¬í”„íŠ¸.txt íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤")
    
    # ì¥ ë²”ìœ„ ì„ íƒ
    st.write("**ìƒì„±í•  ì¥ ë²”ìœ„ ì„ íƒ** (ê¶Œì¥: 3ì¥ì”©)")
    
    ì¥_ì˜µì…˜ = {
        "1~3ì¥": list(range(1, 4)),
        "4~6ì¥": list(range(4, 7)),
        "7~9ì¥": list(range(7, 10)),
        "10~12ì¥": list(range(10, 13)),
        "13~15ì¥": list(range(13, 16)),
        "ì „ì²´ (1~15ì¥)": list(range(1, 16)),
    }
    
    selected_range = st.selectbox(
        "ì¥ ë²”ìœ„",
        options=list(ì¥_ì˜µì…˜.keys()),
        index=0
    )
    
    selected_chapters = ì¥_ì˜µì…˜[selected_range]
    
    # ë¹„ìš© ì˜ˆìƒ
    cost_per_chapter = 0.05 if "sonnet" in selected_model else 0.01  # USD
    estimated_cost = len(selected_chapters) * cost_per_chapter
    st.caption(f"ğŸ’° ì˜ˆìƒ ë¹„ìš©: ${estimated_cost:.2f} (ì•½ {int(estimated_cost * 1400)}ì›) - {len(selected_chapters)}ì¥")
    
    # ì¥ ëª©ì°¨ í‘œì‹œ
    ì¥_ëª©ì°¨ = {
        1: "ì¼ë…„ ìš´ì„¸ ë¦¬í¬íŠ¸ì˜ í•´ì„ ê´€ì ",
        2: "ì‚¬ì£¼ êµ¬ì¡° í•µì‹¬ ìš”ì•½",
        3: "ì¼ë…„ ì „ì²´ ìš´ì˜ í° íë¦„",
        4: "ìƒë°˜ê¸° ì›”ë³„ ìš´ì˜ ì‘ë™ êµ¬ì¡°",
        5: "í•˜ë°˜ê¸° ì›”ë³„ ìš´ì˜ ë³€í™” í¬ì¸íŠ¸",
        6: "ê°ì •Â·ì‹¬ë¦¬ íë¦„",
        7: "ì¸ê°„ê´€ê³„ ì „ë°˜ì˜ ìš´ íë¦„",
        8: "ì—°ì• Â·ë¶€ë¶€Â·ì´ì„± ìš´",
        9: "ì§ì—…Â·ì¼Â·ì»¤ë¦¬ì–´ ìš´",
        10: "ì¬ë¬¼Â·ìˆ˜ì…Â·ì§€ì¶œ ìš´",
        11: "ê±´ê°•Â·ì—ë„ˆì§€ íë¦„",
        12: "ì„ íƒì´ ì¤‘ìš”í•œ ì‹œì ë“¤",
        13: "ì¡°ì‹¬í•´ì•¼ í•  ì‘ìš©",
        14: "í•´ ìš´ì„ í™œìš©í•˜ëŠ” ì „ëµ",
        15: "ì´ í•œ í•´ê°€ ë‚¨ê¸°ëŠ” ì˜ë¯¸",
    }
    
    with st.expander("ğŸ“‹ ì„ íƒëœ ì¥ ëª©ì°¨"):
        for ch in selected_chapters:
            st.write(f"**ì œ{ch}ì¥.** {ì¥_ëª©ì°¨.get(ch, '')}")
    
    st.divider()
    
    # ============================================
    # ìƒì„± ë²„íŠ¼
    # ============================================
    btn_disabled = not api_key or not r_ì´ë¦„ or not master_prompt
    
    if st.button("ğŸš€ ë³´ê³ ì„œ ìƒì„±", type="primary", use_container_width=True, disabled=btn_disabled):
        
        progress = st.progress(0)
        status = st.empty()
        
        try:
            # 1. ë‚ ì§œ ë³€í™˜ ë° ì‚¬ì£¼ ê³„ì‚°
            status.text("1/5 ì‚¬ì£¼ ê³„ì‚° ì¤‘...")
            
            input_year = r_ìƒë…„ì›”ì¼.year
            input_month = r_ìƒë…„ì›”ì¼.month
            input_day = r_ìƒë…„ì›”ì¼.day
            
            if r_ìŒì–‘ë ¥ == "ìŒë ¥":
                year, month, day = ìŒë ¥_to_ì–‘ë ¥(input_year, input_month, input_day, r_ìœ¤ë‹¬)
                ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(input_year, input_month, input_day, r_ìœ¤ë‹¬)
                ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {r_ì‹œ:02d}:{r_ë¶„:02d}"
            else:
                year, month, day = input_year, input_month, input_day
                ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {r_ì‹œ:02d}:{r_ë¶„:02d}"
                ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬ = ì–‘ë ¥_to_ìŒë ¥(year, month, day)
                ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬)
            
            ì‚¬ì£¼ = calc_ì‚¬ì£¼(year, month, day, r_ì‹œ, r_ë¶„)
            ë‚˜ì´ = datetime.now().year - year + 1
            gender = 'ë‚¨' if r_ì„±ë³„ == 'ë‚¨ì„±' else 'ì—¬'
            
            ê¸°ë³¸ì •ë³´ = {
                'ì´ë¦„': r_ì´ë¦„,
                'ì„±ë³„': r_ì„±ë³„,
                'ë‚˜ì´': ë‚˜ì´,
                'ì–‘ë ¥': ì–‘ë ¥_str,
                'ìŒë ¥': ìŒë ¥_str,
            }
            
            progress.progress(10)
            
            # 2. ìš´ì„¸ ê³„ì‚°
            status.text("2/5 ìš´ì„¸ ê³„ì‚° ì¤‘...")
            ëŒ€ìš´_data = calc_ëŒ€ìš´(year, month, day, r_ì‹œ, r_ë¶„, gender)
            ì„¸ìš´_data = calc_ì„¸ìš´(year, month, day, r_ì‹œ, r_ë¶„)
            ì›”ìš´_data = calc_ì›”ìš´(year, month, day, r_ì‹œ, r_ë¶„)
            ì‹ ì‚´_data = calc_ì‹ ì‚´(ì‚¬ì£¼, gender)
            
            progress.progress(15)
            
            # 3. GPT í…ìŠ¤íŠ¸ ìƒì„±
            status.text("3/5 ì‚¬ì£¼ ë°ì´í„° ìƒì„± ì¤‘...")
            gpt_text = generate_gpt_text(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, gender, ëŒ€ìš´_data, ì„¸ìš´_data, ì›”ìš´_data, ì‹ ì‚´_data)
            
            progress.progress(20)
            
            # 4. ì´ë¯¸ì§€ ìƒì„± (17ì¢…)
            status.text("4/5 ì´ë¯¸ì§€ 17ì¢… ìƒì„± ì¤‘...")
            
            img_dir = f"/tmp/{r_ì´ë¦„}_images"
            os.makedirs(img_dir, exist_ok=True)
            
            # ì›êµ­í‘œ
            create_ì›êµ­í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, f"{img_dir}/01_ì›êµ­í‘œ.png", ì‹ ì‚´_data, ZODIAC_PATH)
            # ëŒ€ìš´í‘œ
            create_ëŒ€ìš´í‘œ(ëŒ€ìš´_data, ê¸°ë³¸ì •ë³´, f"{img_dir}/02_ëŒ€ìš´í‘œ.png")
            # ì„¸ìš´í‘œ
            create_ì„¸ìš´í‘œ(ì„¸ìš´_data, ê¸°ë³¸ì •ë³´, f"{img_dir}/03_ì„¸ìš´í‘œ.png")
            # ì›”ìš´í‘œ
            create_ì›”ìš´í‘œ(ì›”ìš´_data, ê¸°ë³¸ì •ë³´, f"{img_dir}/04_ì›”ìš´í‘œ.png")
            # ì˜¤í–‰ë¶„ì„
            create_ì˜¤í–‰ì°¨íŠ¸(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, f"{img_dir}/05_ì˜¤í–‰ë¶„ì„.png")
            # ì‹­ì„±í‘œ
            create_ì‹­ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, f"{img_dir}/06_ì‹­ì„±í‘œ.png")
            # ì‹ ì‚´í‘œ
            create_ì‹ ì‚´í‘œ(ì‹ ì‚´_data, ê¸°ë³¸ì •ë³´, f"{img_dir}/07_ì‹ ì‚´í‘œ.png")
            # 12ìš´ì„±í‘œ
            create_12ìš´ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, f"{img_dir}/08_12ìš´ì„±í‘œ.png")
            # ì§€ì¥ê°„í‘œ
            create_ì§€ì¥ê°„í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, f"{img_dir}/09_ì§€ì¥ê°„í‘œ.png")
            # í•©ì¶©í˜•íŒŒí•´í‘œ
            create_í•©ì¶©í˜•íŒŒí•´í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, f"{img_dir}/10_í•©ì¶©í˜•íŒŒí•´í‘œ.png")
            # ê¶ì„±í‘œ
            create_ê¶ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, f"{img_dir}/11_ê¶ì„±í‘œ.png")
            # ìœ¡ì¹œí‘œ
            create_ìœ¡ì¹œí‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, gender, f"{img_dir}/12_ìœ¡ì¹œí‘œ.png")
            # ë‚©ìŒì˜¤í–‰í‘œ
            create_ë‚©ìŒì˜¤í–‰í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, f"{img_dir}/13_ë‚©ìŒì˜¤í–‰í‘œ.png")
            # ê²©êµ­í‘œ
            create_ê²©êµ­í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, f"{img_dir}/14_ê²©êµ­í‘œ.png")
            # ê³µë§í‘œ
            create_ê³µë§í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, f"{img_dir}/15_ê³µë§í‘œ.png")
            # ìš©ì‹ í‘œ
            create_ìš©ì‹ í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, f"{img_dir}/16_ìš©ì‹ í‘œ.png")
            
            progress.progress(30)
            
            # 5. Claude API í˜¸ì¶œ (ì¥ë³„)
            status.text("5/5 Claude APIë¡œ ì¥ë³„ í•´ì„ ìƒì„± ì¤‘...")
            
            import anthropic
            client = anthropic.Anthropic(api_key=api_key)
            
            # Docx ì €ì¥ í´ë”
            docx_dir = f"/tmp/{r_ì´ë¦„}_docx"
            os.makedirs(docx_dir, exist_ok=True)
            
            generated_files = []
            total_ch = len(selected_chapters)
            
            for idx, ch_num in enumerate(selected_chapters):
                status.text(f"5/5 ì œ{ch_num}ì¥ ìƒì„± ì¤‘... ({idx+1}/{total_ch})")
                
                # Claude API í˜¸ì¶œ
                user_message = f"""[ì‚¬ì£¼ ë°ì´í„°]
{gpt_text}

ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ "ì œ{ch_num}ì¥. {ì¥_ëª©ì°¨.get(ch_num, '')}"ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
ëª©ì°¨ì˜ ì†Œì£¼ì œë¥¼ ëª¨ë‘ í¬í•¨í•˜ì—¬ ì‘ì„±í•˜ì„¸ìš”."""
                
                response = client.messages.create(
                    model=selected_model,
                    max_tokens=8000,
                    system=master_prompt,
                    messages=[
                        {"role": "user", "content": user_message}
                    ]
                )
                
                chapter_content = response.content[0].text
                
                # Docx ì €ì¥
                from docx import Document
                from docx.shared import Pt
                from docx.oxml.ns import qn
                
                doc = Document()
                
                # ìŠ¤íƒ€ì¼ ì„¤ì •
                style = doc.styles['Normal']
                style.font.name = 'ë§‘ì€ ê³ ë”•'
                style.font.size = Pt(17)
                style._element.rPr.rFonts.set(qn('w:eastAsia'), 'ë§‘ì€ ê³ ë”•')
                
                # ë‚´ìš© ì¶”ê°€
                for para_text in chapter_content.split('\n'):
                    if para_text.strip():
                        doc.add_paragraph(para_text.strip())
                
                # íŒŒì¼ ì €ì¥
                docx_filename = f"ì œ{ch_num}ì¥_{ì¥_ëª©ì°¨.get(ch_num, '').replace('Â·', '_')}.docx"
                docx_path = os.path.join(docx_dir, docx_filename)
                doc.save(docx_path)
                generated_files.append(docx_path)
                
                progress.progress(30 + int(65 * (idx + 1) / total_ch))
            
            progress.progress(100)
            status.text("âœ… ì™„ë£Œ!")
            
            # ZIP ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
            zip_buffer = io.BytesIO()
            with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zf:
                # Docx íŒŒì¼ë“¤
                for docx_path in generated_files:
                    zf.write(docx_path, os.path.basename(docx_path))
                
                # ì´ë¯¸ì§€ íŒŒì¼ë“¤
                for img_file in os.listdir(img_dir):
                    img_path = os.path.join(img_dir, img_file)
                    zf.write(img_path, f"images/{img_file}")
                
                # GPT í…ìŠ¤íŠ¸
                gpt_text_path = f"/tmp/{r_ì´ë¦„}_ì‚¬ì£¼ë°ì´í„°.txt"
                with open(gpt_text_path, 'w', encoding='utf-8') as f:
                    f.write(gpt_text)
                zf.write(gpt_text_path, f"{r_ì´ë¦„}_ì‚¬ì£¼ë°ì´í„°.txt")
            
            zip_buffer.seek(0)
            
            st.download_button(
                label=f"ğŸ“¥ {r_ì´ë¦„}_{selected_range} ë‹¤ìš´ë¡œë“œ (ZIP)",
                data=zip_buffer,
                file_name=f"{r_ì´ë¦„}_{selected_range.replace('~', '-')}_ë³´ê³ ì„œ.zip",
                mime="application/zip",
                use_container_width=True
            )
            
            # ìƒì„± ê²°ê³¼ í‘œì‹œ
            st.success(f"âœ… {len(generated_files)}ê°œ ì¥ ìƒì„± ì™„ë£Œ!")
            
            with st.expander("ğŸ“– ìƒì„±ëœ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°"):
                for docx_path in generated_files:
                    filename = os.path.basename(docx_path)
                    st.subheader(filename.replace('.docx', ''))
                    
                    doc = Document(docx_path)
                    preview_text = '\n'.join([p.text for p in doc.paragraphs[:10]])
                    st.write(preview_text[:1000] + "..." if len(preview_text) > 1000 else preview_text)
                    st.divider()
        
        except Exception as e:
            st.error(f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            import traceback
            st.code(traceback.format_exc())

# ============================================
# íƒ­5: ë°œì†¡ ê´€ë¦¬
# ============================================
with tab5:
    st.subheader("ğŸ“§ ì´ë©”ì¼ & ì¹´ì¹´ì˜¤ ë°œì†¡ ê´€ë¦¬")
    
    if not MODULES_AVAILABLE:
        st.error("âš ï¸ ë°œì†¡ ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨")
        st.stop()
    
    st.info("""
    **ë°œì†¡ ê¸°ëŠ¥**
    - Gmail SMTPë¡œ ì´ë©”ì¼ ë°œì†¡
    - Google Drive ì—…ë¡œë“œ í›„ ë§í¬ ì „ì†¡
    - ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡/ì¹œêµ¬í†¡ (ë³„ë„ ì„¤ì • í•„ìš”)
    """)
    
    # ============================================
    # Gmail ì„¤ì •
    # ============================================
    with st.expander("ğŸ“§ Gmail ì„¤ì •", expanded=True):
        gmail_col1, gmail_col2 = st.columns(2)
        with gmail_col1:
            sender_email = st.text_input("Gmail ì£¼ì†Œ", placeholder="your@gmail.com")
        with gmail_col2:
            sender_password = st.text_input("ì•± ë¹„ë°€ë²ˆí˜¸", type="password", 
                                           help="Google ê³„ì • â†’ ë³´ì•ˆ â†’ 2ë‹¨ê³„ ì¸ì¦ â†’ ì•± ë¹„ë°€ë²ˆí˜¸")
    
    # ============================================
    # Google Drive ì„¤ì •
    # ============================================
    with st.expander("â˜ï¸ Google Drive ì„¤ì •"):
        drive_folder_id = st.text_input("ë“œë¼ì´ë¸Œ í´ë” ID", 
                                        help="ë“œë¼ì´ë¸Œ í´ë” URLì—ì„œ folders/ ë’¤ì˜ ID")
        drive_credentials = st.text_area("ì„œë¹„ìŠ¤ ê³„ì • JSON", height=100,
                                         help="GCP ì„œë¹„ìŠ¤ ê³„ì • JSON í‚¤")
    
    st.divider()
    
    # ============================================
    # ê°œë³„ ë°œì†¡
    # ============================================
    st.subheader("ğŸ“¤ ê°œë³„ ë°œì†¡")
    
    send_col1, send_col2 = st.columns(2)
    
    with send_col1:
        recipient_email = st.text_input("ìˆ˜ì‹ ì ì´ë©”ì¼", placeholder="customer@email.com")
        recipient_name = st.text_input("ìˆ˜ì‹ ì ì´ë¦„", placeholder="í™ê¸¸ë™")
    
    with send_col2:
        uploaded_pdf = st.file_uploader("PDF íŒŒì¼", type=["pdf"])
        email_subject = st.text_input("ì´ë©”ì¼ ì œëª©", value="{name}ë‹˜ì˜ ì‚¬ì£¼ ë¶„ì„ ë³´ê³ ì„œ")
    
    email_body = st.text_area(
        "ì´ë©”ì¼ ë³¸ë¬¸ (HTML)",
        value=get_default_email_template(),
        height=200
    )
    
    if st.button("ğŸ“§ ì´ë©”ì¼ ë°œì†¡", type="primary", disabled=not all([sender_email, sender_password, recipient_email, uploaded_pdf])):
        with st.spinner("ë°œì†¡ ì¤‘..."):
            try:
                # PDF ì„ì‹œ ì €ì¥
                pdf_path = f"/tmp/{recipient_name}_report.pdf"
                with open(pdf_path, 'wb') as f:
                    f.write(uploaded_pdf.read())
                
                drive_link = None
                
                # ë“œë¼ì´ë¸Œ ì—…ë¡œë“œ (ì„¤ì •ëœ ê²½ìš°)
                if drive_folder_id and drive_credentials:
                    st.text("â˜ï¸ ë“œë¼ì´ë¸Œ ì—…ë¡œë“œ ì¤‘...")
                    result = upload_to_drive(
                        file_path=pdf_path,
                        folder_id=drive_folder_id,
                        credentials_json=drive_credentials,
                        file_name=f"{recipient_name}_ì‚¬ì£¼ë³´ê³ ì„œ.pdf"
                    )
                    drive_link = result['web_link']
                    st.success(f"âœ… ë“œë¼ì´ë¸Œ ì—…ë¡œë“œ ì™„ë£Œ: {drive_link}")
                
                # ì´ë©”ì¼ ë°œì†¡
                st.text("ğŸ“§ ì´ë©”ì¼ ë°œì†¡ ì¤‘...")
                result = send_email(
                    to_email=recipient_email,
                    subject=email_subject.format(name=recipient_name),
                    body=email_body.format(name=recipient_name, drive_link=drive_link or ""),
                    sender_email=sender_email,
                    sender_password=sender_password,
                    drive_link=drive_link
                )
                
                if result['success']:
                    st.success(result['message'])
                else:
                    st.error(result['message'])
            
            except Exception as e:
                st.error(f"ë°œì†¡ ì‹¤íŒ¨: {str(e)}")
    
    st.divider()
    
    # ============================================
    # ëŒ€ëŸ‰ ë°œì†¡ (ì—‘ì…€)
    # ============================================
    st.subheader("ğŸ“Š ëŒ€ëŸ‰ ë°œì†¡ (ì—‘ì…€)")
    
    st.write("""
    **ì—‘ì…€ í˜•ì‹**: ì´ë¦„, ì´ë©”ì¼, PDFíŒŒì¼ê²½ë¡œ (ë˜ëŠ” ë“œë¼ì´ë¸Œë§í¬)
    """)
    
    bulk_excel = st.file_uploader("ë°œì†¡ ëª©ë¡ ì—‘ì…€", type=["xlsx", "xls"], key="bulk_send")
    
    if bulk_excel:
        df = pd.read_excel(bulk_excel)
        st.dataframe(df, use_container_width=True)
        
        if st.button("ğŸ“§ ì¼ê´„ ë°œì†¡", type="primary"):
            st.warning("âš ï¸ ì¼ê´„ ë°œì†¡ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.")

